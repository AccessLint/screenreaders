#!/bin/sh

set -e

# Turn off splash screen
/usr/libexec/PlistBuddy -c "Set :doNotShowSplashScreen YES" \
  ~/Library/Preferences/com.apple.VoiceOverTraining.plist || \
  /usr/libexec/PlistBuddy -c "Add :doNotShowSplashScreen bool YES" \
  ~/Library/Preferences/com.apple.VoiceOverTraining.plist

# Enable AppleScript
/usr/libexec/PlistBuddy -c "Set :SCREnableAppleScript YES" \
  ~/Library/Preferences/com.apple.VoiceOver4/default.plist || \
  /usr/libexec/PlistBuddy -c "Add :SCREnableAppleScript bool YES" \
  ~/Library/Preferences/com.apple.VoiceOver4/default.plist

osascript -e 'tell application "System Events" to tell process "VoiceOver Utility" to click checkbox "Allow VoiceOver to be controlled with AppleScript" of group 1 of window "VoiceOver Utility"'


open "$1" -a Safari

# start VoiceOver
/System/Library/CoreServices/VoiceOver.app/Contents/MacOS/VoiceOverStarter

sleep 5

osascript -e 'tell application "VoiceOver" to copy to pasteboard last phrase'
osascript -e 'tell application "VoiceOver" to grab screenshot vo cursor'

expected="$2"
actual="$(pbpaste)"

if [[ "$actual" =~ .*"$expected".* ]]; then
  echo "üëç passed assertion"
else
  echo "‚ùåfailed 1 assertion. Expected \"$expected\" in \"$actual\""
fi

pid="$(pgrep "VoiceOver")"
pkill "$pid"
